<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="keywords" content="sosyaltrend,sosyal aƒü,sosyal,aƒü,sosyalaƒü,√ºcretsiz sosyal aƒü">
  <title>SosyaLTrend ‚Ä¢ Sosyal Aƒü - Anasayfa</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" type="image/x-icon" href="assets/img/strendsaydamv2.ico">
    <style>
    .app-container.messages-layout {
      grid-template-columns: 300px 1fr;
      gap: 0;
      padding: 0 0 0 0;
      max-width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    /* ===== SOL PANEL ===== */
    .conversations-panel {
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 136px);
      overflow: hidden;
      position: relative;
    }

    .conv-header {
      padding: 16px 14px 10px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .conv-header h2 {
      font-size: 1.05rem;
      font-weight: 800;
      margin-bottom: 10px;
      color: var(--text-main);
    }

    .conv-search { position: relative; }

    .conv-search input {
      width: 100%;
      padding: 8px 12px 8px 34px;
      border-radius: 20px;
      border: 1.5px solid var(--border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 0.83rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .conv-search input:focus { border-color: var(--primary); }

    .conv-search i {
      position: absolute;
      left: 11px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .conv-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .conv-tab {
      flex: 1;
      padding: 9px 6px;
      border: none;
      background: none;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }

    .conv-tab.active { color: var(--primary); }

    .conv-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20%;
      right: 20%;
      height: 2px;
      background: var(--primary);
      border-radius: 2px 2px 0 0;
    }

    .conv-list {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .conv-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.15s;
      border-left: 3px solid transparent;
    }

    .conv-item:hover { background: var(--input-bg); }

    .conv-item.active {
      background: linear-gradient(90deg, rgba(99,102,241,0.1), transparent);
      border-left-color: var(--primary);
    }

    .conv-avatar-wrap { position: relative; flex-shrink: 0; }

    .conv-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
    }

    .online-dot {
      position: absolute;
      bottom: 1px;
      right: 1px;
      width: 11px;
      height: 11px;
      border-radius: 50%;
      background: var(--online-green);
      border: 2px solid var(--card-bg);
    }

    .offline-dot { background: var(--text-muted); }

    .conv-info { flex: 1; min-width: 0; }

    .conv-name-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .conv-name {
      font-weight: 700;
      font-size: 0.86rem;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conv-time { font-size: 0.7rem; color: var(--text-muted); flex-shrink: 0; margin-left: 4px; }

    .conv-preview {
      font-size: 0.77rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conv-badge {
      background: var(--primary);
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 10px;
      padding: 2px 6px;
      flex-shrink: 0;
      margin-left: 4px;
    }

    .new-msg-fab {
      position: sticky;
      bottom: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 10px 14px;
      flex-shrink: 0;
    }

    .new-msg-fab button {
      width: 100%;
      padding: 9px;
      background: var(--msg-my-bg);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      transition: opacity 0.2s, transform 0.15s;
    }

    .new-msg-fab button:hover { opacity: 0.9; transform: translateY(-1px); }

    /* ===== SAƒû PANEL ===== */
    .chat-panel {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 136px);
      background: #fff;
    }

    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      gap: 12px;
    }

    .chat-empty i {
      font-size: 3.2rem;
      background: var(--msg-my-bg);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      opacity: 0.5;
    }

    .chat-empty p { font-size: 0.88rem; font-weight: 500; }

    .chat-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }

    .chat-header-avatar { position: relative; }

    .chat-header-avatar img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
    }

    .chat-header-info { flex: 1; }
    .chat-header-name { font-weight: 800; font-size: 0.92rem; color: var(--text-main); }

    .chat-header-status {
      font-size: 0.75rem;
      color: var(--online-green);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chat-header-status.offline { color: var(--text-muted); }

    .chat-header-status::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .chat-header-actions { display: flex; gap: 7px; }

    .chat-action-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1.5px solid var(--border);
      background: var(--input-bg);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .chat-action-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .date-divider { text-align: center; margin: 12px 0; }

    .date-divider span {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--border);
      padding: 3px 10px;
      border-radius: 8px;
    }

    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 7px;
      max-width: 68%;
      animation: msgIn 0.22s ease;
    }

    @keyframes msgIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
    .msg-row.theirs { align-self: flex-start; }

    .msg-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      border: 1.5px solid var(--border);
    }

    .msg-bubble {
      padding: 9px 13px;
      border-radius: 18px;
      font-size: 0.87rem;
      line-height: 1.5;
      word-break: break-word;
      max-width: 100%;
    }

    .msg-row.mine .msg-bubble {
      background: var(--msg-my-bg);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .msg-row.theirs .msg-bubble {
      background: var(--card-bg);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .msg-meta {
      font-size: 0.66rem;
      margin-top: 3px;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .msg-row.mine .msg-meta { justify-content: flex-end; color: rgba(255,255,255,0.65); }
    .msg-row.theirs .msg-meta { color: var(--text-muted); }
    .msg-check.read { color: #60a5fa; }

    .msg-img {
      max-width: 200px;
      border-radius: 10px;
      cursor: pointer;
      transition: opacity 0.2s;
      display: block;
    }

    .msg-img:hover { opacity: 0.85; }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 7px;
      align-self: flex-start;
      animation: msgIn 0.22s ease;
    }

    .typing-indicator img {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      object-fit: cover;
      border: 1.5px solid var(--border);
    }

    .typing-dots {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      padding: 9px 13px;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--primary);
      animation: typingB 1.2s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingB {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
      30% { transform: translateY(-5px); opacity: 1; }
    }

    .chat-footer {
      padding: 10px 14px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: flex-end;
      gap: 9px;
      flex-shrink: 0;
      position: relative;
    }

    .input-wrap {
      flex: 1;
      background: var(--input-bg);
      border: 1.5px solid var(--border);
      border-radius: 22px;
      padding: 7px 12px;
      display: flex;
      align-items: flex-end;
      gap: 7px;
      transition: border-color 0.2s;
    }

    .input-wrap:focus-within { border-color: var(--primary); }

    .input-wrap textarea {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      resize: none;
      color: var(--text-main);
      font-size: 0.88rem;
      font-family: inherit;
      max-height: 90px;
      min-height: 20px;
      line-height: 1.4;
    }

    .input-actions { display: flex; align-items: center; gap: 5px; }

    .input-icon-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.95rem;
      padding: 2px 3px;
      transition: color 0.2s;
      display: flex;
      align-items: center;
    }

    .input-icon-btn:hover { color: var(--primary); }

    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--msg-my-bg);
      border: none;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s, box-shadow 0.2s;
      flex-shrink: 0;
      box-shadow: 0 3px 10px rgba(99,102,241,0.35);
    }

    .send-btn:hover { transform: scale(1.08); box-shadow: 0 5px 14px rgba(99,102,241,0.5); }
    .send-btn:active { transform: scale(0.95); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .msg-emoji-picker {
      position: absolute;
      bottom: 62px;
      left: 14px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      display: none;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      z-index: 200;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      max-width: 270px;
    }

    .msg-emoji-picker.open { display: grid; animation: msgIn 0.18s ease; }

    .msg-emoji-picker span {
      cursor: pointer;
      font-size: 1.15rem;
      padding: 3px;
      border-radius: 5px;
      text-align: center;
      transition: background 0.12s;
    }

    .msg-emoji-picker span:hover { background: var(--input-bg); }

    .send-image-preview {
      padding: 7px 14px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      display: none;
      align-items: center;
      gap: 9px;
    }

    .send-image-preview.show { display: flex; }

    .send-image-preview img {
      width: 50px;
      height: 50px;
      border-radius: 7px;
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .remove-img-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.7rem;
    }

    .new-chat-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(4px);
      z-index: 5000;
      align-items: center;
      justify-content: center;
    }

    .new-chat-modal.open { display: flex; }

    .new-chat-inner {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 22px;
      width: 90%;
      max-width: 360px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.18);
      animation: msgIn 0.22s ease;
    }

    .new-chat-inner h3 { font-size: 0.95rem; font-weight: 800; margin-bottom: 12px; }

    .new-chat-inner input {
      width: 100%;
      padding: 9px 12px;
      border-radius: 10px;
      border: 1.5px solid var(--border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 0.85rem;
      outline: none;
      margin-bottom: 12px;
    }

    .new-chat-inner input:focus { border-color: var(--primary); }

    .user-search-results {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 220px;
      overflow-y: auto;
    }

    .user-search-item {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 7px 9px;
      border-radius: 9px;
      cursor: pointer;
      transition: background 0.12s;
    }

    .user-search-item:hover { background: var(--input-bg); }

    .user-search-item img {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      object-fit: cover;
      border: 1.5px solid var(--border);
    }

    .user-search-item .info .name { font-weight: 700; font-size: 0.83rem; }
    .user-search-item .info .handle { font-size: 0.72rem; color: var(--text-muted); }

    .loading-conv {
      padding: 20px;
      text-align: center;
      font-size: 0.82rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .loading-spin {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .msgs-loading {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
      color: var(--text-muted);
      font-size: 0.83rem;
    }

    .msg-toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.14);
      z-index: 9999;
      animation: toastIn 0.3s ease;
      max-width: 280px;
      cursor: pointer;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-toast img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    .msg-toast .toast-name { font-weight: 700; font-size: 0.82rem; }
    .msg-toast .toast-text { font-size: 0.78rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }

    @media (max-width: 768px) {
      .app-container.messages-layout {
        grid-template-columns: 1fr;
        padding: 104px 0 0 0;
        border-radius: 1rem;
      }

      .conversations-panel {
        height: calc(100vh - 104px);
        position: absolute;
        left: 0; right: 0;
        z-index: 10;
        transition: transform 0.28s ease;
      }

      .conversations-panel.hidden-mobile { transform: translateX(-100%); }

      .chat-panel {
        height: calc(100vh - 104px);
        position: absolute;
        left: 0; right: 0;
        transform: translateX(100%);
        transition: transform 0.28s ease;
      }

      .chat-panel.show-mobile { transform: translateX(0); }
      .back-btn { display: flex !important; }
      .msg-row { max-width: 82%; }
    }

    .back-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text-main);
      font-size: 1rem;
      cursor: pointer;
      padding: 4px 6px;
      margin-right: 2px;
    }
  </style>
</head>
<body>
  
  <div class="top-bar">
    <div class="top-bar-left">
      <span id="welcomeMessage" style="opacity: 0.8;"><i class="fa-solid fa-circle-check" style="font-size: 0.6rem; animation: pulse 2s infinite;"></i> Y√ºkleniyor...</span>
    </div>
    <div class="top-bar-right"><span id="topBarDateTime"><i class="fa-regular fa-clock"></i> Y√ºkleniyor...</span></div>
  </div>

<div id="header-placeholder"></div>

<div class="app-container">
  <div data-include="partials/left-aside.html"></div>

 <main id="main-content">
   <div class="ramadan-widget">
    <div id="status-title" class="timer-title">Ramazan 2026</div>
    
    <div id="ramadan-countdown" class="ramadan-timer">
        <div class="timer-item"><span class="timer-value" id="r-day">00</span><span class="timer-label">G√ºn</span></div>
        <div class="timer-item"><span class="timer-value" id="r-hour">00</span><span class="timer-label">Saat</span></div>
        <div class="timer-item"><span class="timer-value" id="r-min">00</span><span class="timer-label">Dak</span></div>
        <div class="timer-item"><span class="timer-value" id="r-sec">00</span><span class="timer-label">Sn</span></div>
    </div>
    <span class="current-city-label">üìç <span id="active-city-name">ƒ∞stanbul</span> ƒ∞msakiyesi</span>

    <div class="widget-actions">
        <select id="city-select" class="w-select" onchange="changeCity(this.value)">
            </select>
        <button class="w-btn" onclick="openImsakiye()">üìÖ Tam ƒ∞msakiye</button>
    </div>
</div>

<div id="imsakiye-modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeImsakiye()">&times;</span>
        <h3 id="modal-city-title">ƒ∞msakiye 2026</h3>
        <p>Vakitler Diyanet ƒ∞≈üleri Ba≈ükanlƒ±ƒüƒ± uyumludur.</p>
        <table class="imsakiye-table">
            <thead>
                <tr>
                    <th>G√ºn</th>
                    <th>Tarih</th>
                    <th>ƒ∞msak</th>
                    <th>ƒ∞ftar</th>
                </tr>
            </thead>
            <tbody id="imsakiye-body">
                </tbody>
        </table>
    </div>
</div>
 <div class="app-container messages-layout">

    <!-- SOL: KONU≈ûMALAR -->
    <div class="conversations-panel" id="convPanel">
      <div class="conv-header">
        <h2><i class="fa-solid fa-comments" style="color:var(--primary); margin-right:6px;"></i>Mesajlar</h2>
        <div class="conv-search">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" placeholder="Konu≈üma ara..." id="convSearch" oninput="filterConversations(this.value)">
        </div>
      </div>

      <div class="conv-tabs">
        <button class="conv-tab active" onclick="switchTab(this,'all')">T√ºm√º</button>
        <button class="conv-tab" onclick="switchTab(this,'unread')">
          Okunmadƒ±
          <span id="unreadCountBadge" style="background:var(--primary);color:white;font-size:0.62rem;padding:1px 5px;border-radius:8px;margin-left:3px;display:none;">0</span>
        </button>
      </div>

      <div class="conv-list" id="convList">
        <div class="loading-conv">
          <div class="loading-spin"></div>
          <span>Konu≈ümalar y√ºkleniyor...</span>
        </div>
      </div>

      <div class="new-msg-fab">
        <button onclick="openNewChatModal()">
          <i class="fa-solid fa-pen-to-square"></i> Yeni Mesaj
        </button>
      </div>
    </div>

    <!-- SAƒû: CHAT -->
    <div class="chat-panel" id="chatPanel">
      <div class="chat-empty" id="chatEmpty">
        <i class="fa-solid fa-comments"></i>
        <p>Bir konu≈üma se√ß veya yeni mesaj ba≈ülat</p>
      </div>

      <div id="activeChatArea" style="display:none; flex-direction:column; height:100%; background: #fff;">
        <div class="chat-header">
          <button class="back-btn" onclick="showConvPanel()">
            <i class="fa-solid fa-chevron-left"></i>
          </button>
          <div class="chat-header-avatar">
            <img id="chatAvatar" src="" alt="">
            <div class="online-dot offline-dot" id="chatOnlineDot"></div>
          </div>
          <div class="chat-header-info">
            <div class="chat-header-name" id="chatName">-</div>
            <div class="chat-header-status offline" id="chatStatus">Y√ºkleniyor...</div>
          </div>
          <div class="chat-header-actions">
            <button class="chat-action-btn" title="Profili G√∂r" id="viewProfileBtn">
              <i class="fa-solid fa-user"></i>
            </button>
            <button class="chat-action-btn" title="Konu≈ümayƒ± Sil" onclick="clearChat()">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="msgs-loading">
            <div class="loading-spin"></div>
            <span>Mesajlar y√ºkleniyor...</span>
          </div>
        </div>

        <div class="send-image-preview" id="sendImgPreview">
          <img id="sendImgThumb" src="" alt="">
          <span id="sendImgName" style="font-size:0.78rem; color:var(--text-muted); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></span>
          <button class="remove-img-btn" onclick="removeSendImg()"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="msg-emoji-picker" id="msgEmojiPicker">
          <span>üòä</span><span>üòç</span><span>üòÇ</span><span>ü§£</span><span>üòé</span><span>ü•≥</span><span>üò≠</span><span>üòÖ</span>
          <span>‚ù§Ô∏è</span><span>üíô</span><span>üíö</span><span>üß°</span><span>üíú</span><span>üñ§</span><span>ü§ç</span><span>üíØ</span>
          <span>üëç</span><span>üëé</span><span>üëè</span><span>üôå</span><span>ü§ù</span><span>üôè</span><span>üí™</span><span>ü§û</span>
          <span>üî•</span><span>‚ú®</span><span>üéâ</span><span>üéä</span><span>üéà</span><span>üöÄ</span><span>‚≠ê</span><span>üí´</span>
          <span>üò°</span><span>üò§</span><span>ü§î</span><span>üòÆ</span><span>üò±</span><span>üò¥</span><span>ü•±</span><span>üò∑</span>
        </div>

        <div class="chat-footer">
          <input type="file" id="chatImgInput" accept="image/*" style="display:none;" onchange="handleImgSelect(this)">
          <div class="input-wrap">
            <textarea
              id="msgInput"
              placeholder="Mesaj yaz..."
              rows="1"
              onkeydown="handleMsgKeydown(event)"
              oninput="autoResize(this); handleTyping();"
            ></textarea>
            <div class="input-actions">
              <button class="input-icon-btn" title="Resim ekle" onclick="document.getElementById('chatImgInput').click()">
                <i class="fa-regular fa-image"></i>
              </button>
              <button class="input-icon-btn" title="Emoji" id="emojiToggleBtn" onclick="toggleEmojiPicker()">
                <i class="fa-regular fa-face-smile"></i>
              </button>
            </div>
          </div>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- YENƒ∞ MESAJ MODALI -->
  <div class="new-chat-modal" id="newChatModal">
    <div class="new-chat-inner">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
        <h3 style="margin:0;">Yeni Mesaj</h3>
        <button onclick="closeNewChatModal()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text-muted);line-height:1;">&times;</button>
      </div>
      <input type="text" placeholder="Kullanƒ±cƒ± ara..." id="userSearchInput" oninput="searchUsers(this.value)" autocomplete="off">
      <div class="user-search-results" id="userSearchResults">
        <div style="text-align:center; color:var(--text-muted); font-size:0.82rem; padding:10px;">Arama yapmak i√ßin yazmaya ba≈üla</div>
      </div>
    </div>
  </div>
</main>

<div data-include="partials/right-aside.html"></div>
</div>


<div id="editModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div class="glass-card" style="width: 90%; max-width: 500px; padding: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <h3 style="margin: 0;">G√∂nderiyi D√ºzenle</h3>
            <button onclick="closeEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main);">&times;</button>
        </div>
        <textarea id="editPostInput" style="width: 100%; min-height: 120px; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: transparent; color: var(--text-main); outline: none; resize: vertical;"></textarea>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
            <button onclick="closeEditModal()" style="padding: 8px 20px; border-radius: 20px; border: 1px solid var(--border); background: transparent; cursor: pointer;">ƒ∞ptal</button>
            <button id="saveEditBtn" style="padding: 8px 20px; border-radius: 20px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer;">Kaydet</button>
        </div>
    </div>
</div>

<div id="footer-placeholder"></div>  
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs,
      query, orderBy, onSnapshot, serverTimestamp, updateDoc, deleteDoc,
      where, limit, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // ‚îÄ‚îÄ‚îÄ Firebase ‚îÄ‚îÄ‚îÄ
    const firebaseConfig = {
      apiKey: "AIzaSyBegJHqlfPagx8biFyS_FnE3iXOksgfoAU",
      authDomain: "sosyaltrend-21d21.firebaseapp.com",
      projectId: "sosyaltrend-21d21",
      storageBucket: "sosyaltrend-21d21.firebasestorage.app",
      messagingSenderId: "207734473261",
      appId: "1:207734473261:web:f31b6bf2908c6d88986ea4"
    };

    const fbApp  = initializeApp(firebaseConfig);
    const db     = getFirestore(fbApp);
    const auth   = getAuth(fbApp);
    const storage = getStorage(fbApp);

    // Auth kontrol√º (onAuthStateChanged) i√ßinde, listenConversations() √ßaƒürƒ±sƒ±ndan hemen sonra:
const urlParams = new URLSearchParams(window.location.search);
const startId = urlParams.get('start');

if (startId) {
  // Eƒüer URL'de ?start=ID varsa, o ki≈üiyle sohbeti ba≈ülat
  setTimeout(() => {
    window.startConvWith(startId); //
  }, 1500); // Verilerin y√ºklenmesi i√ßin kƒ±sa bir bekleme
}

    // ‚îÄ‚îÄ‚îÄ Durum ‚îÄ‚îÄ‚îÄ
    let currentUser    = null;
    let currentConvId  = null;
    let currentOther   = null;
    let msgsUnsub      = null;
    let typingUnsub    = null;
    let convUnsub      = null;
    let typingTimer    = null;
    let pendingFile    = null;
    let currentTab     = 'all';
    let allConvs       = [];
    let searchFilter   = '';

    // ‚îÄ‚îÄ‚îÄ Yardƒ±mcƒ±lar ‚îÄ‚îÄ‚îÄ
    const esc = t => String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    const fb  = name => `https://ui-avatars.com/api/?name=${encodeURIComponent(name||'U')}&background=6366f1&color=fff`;

    function convId(a, b) { return [a,b].sort().join('_'); }

    function fmtTime(ts) {
      if (!ts) return '';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const now = new Date(), diff = now - d;
      if (diff < 60000)       return '≈ûimdi';
      if (diff < 3600000)     return Math.floor(diff/60000) + ' dk';
      if (diff < 86400000)    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      if (diff < 172800000)   return 'D√ºn';
      if (diff < 604800000)   return ['Paz','Pzt','Sal','√áar','Per','Cum','Cmt'][d.getDay()];
      return `${d.getDate()}/${d.getMonth()+1}`;
    }

    function fullTime(ts) {
      if (!ts) return '';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    // ‚îÄ‚îÄ‚îÄ Saat ‚îÄ‚îÄ‚îÄ
    function tick() {
      const now = new Date();
      const el = document.getElementById('topBarDateTime');
      if (el) el.innerHTML = `<i class="fa-regular fa-clock"></i> ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    }
    setInterval(tick, 1000); tick();

    // ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ
    onAuthStateChanged(auth, async u => {
      if (!u) { window.location.href = 'giris.html'; return; }
      const snap = await getDoc(doc(db,'users',u.uid));
      const d = snap.data() || {};
      currentUser = {
        uid: u.uid,
        displayName: d.displayName || u.displayName || 'Kullanƒ±cƒ±',
        username: d.username || '',
        avatar: d.avatar || u.photoURL || fb(d.displayName||u.displayName)
      };
      setPresence();
      listenConversations();
    });

    // ‚îÄ‚îÄ‚îÄ Presence (√áevrimi√ßi durumu) ‚îÄ‚îÄ‚îÄ
    async function setPresence() {
      if (!currentUser) return;
      const presRef = doc(db,'presence', currentUser.uid);
      await setDoc(presRef, { state:'online', lastChanged: serverTimestamp() });
      window.addEventListener('beforeunload', () => {
        // Firestore'da offline yaz - best effort
        navigator.sendBeacon && navigator.sendBeacon('/offline-ping', '');
      });
      // Periyodik heartbeat
      setInterval(() => setDoc(presRef, { state:'online', lastChanged: serverTimestamp() }), 60000);
    }

    // ‚îÄ‚îÄ‚îÄ KONU≈ûMALARI Dƒ∞NLE ‚îÄ‚îÄ‚îÄ
    function listenConversations() {
      const q = query(
  collection(db, 'conversations'), // Koleksiyona git
  where('participants', 'array-contains', currentUser.uid), // "Benim olduƒüum mesajlarƒ± bul" (Filtre)
  orderBy('lastMessageAt', 'desc') // "En son mesaja g√∂re sƒ±rala" (Sƒ±ralama)
);

      convUnsub = onSnapshot(q, async snap => {
        allConvs = [];
        const jobs = snap.docs.map(async d => {
          const data = d.data();
          const otherId = (data.participants||[]).find(p => p !== currentUser.uid);
          if (!otherId) return;
          const os = await getDoc(doc(db,'users',otherId));
          const o = os.data() || {};
          allConvs.push({
            id: d.id, otherId,
            otherName:     o.displayName || 'Kullanƒ±cƒ±',
            otherUsername: o.username || '',
            otherAvatar:   o.avatar || fb(o.displayName),
            lastMessage:   data.lastMessage || '',
            lastMessageAt: data.lastMessageAt,
            lastSenderId:  data.lastSenderId || '',
            unread: (data.unreadCount||{})[currentUser.uid] || 0
          });
        });
        await Promise.all(jobs);
        allConvs.sort((a,b) => (b.lastMessageAt?.toDate?.() || 0) - (a.lastMessageAt?.toDate?.() || 0));
        renderConvList();
        updateUnreadBadge();
      });
    }

    // ‚îÄ‚îÄ‚îÄ KONU≈ûMA Lƒ∞STESƒ∞ ‚îÄ‚îÄ‚îÄ
    function renderConvList() {
      const c = document.getElementById('convList');
      let list = [...allConvs];
      if (currentTab === 'unread') list = list.filter(x => x.unread > 0);
      if (searchFilter) {
        const q = searchFilter.toLowerCase();
        list = list.filter(x => x.otherName.toLowerCase().includes(q) || x.otherUsername.toLowerCase().includes(q));
      }

      if (list.length === 0) {
        c.innerHTML = `<div style="text-align:center;padding:28px;color:var(--text-muted);font-size:0.82rem;">${
          searchFilter ? 'Sonu√ß bulunamadƒ±' : currentTab === 'unread' ? 'Okunmamƒ±≈ü mesaj yok' : 'Hen√ºz hi√ß mesajƒ±n yok'
        }</div>`;
        return;
      }

      c.innerHTML = '';
      list.forEach(conv => {
        const active  = conv.id === currentConvId;
        const preview = conv.lastSenderId === currentUser.uid ? `Sen: ${conv.lastMessage}` : conv.lastMessage;
        const el = document.createElement('div');
        el.className = `conv-item${active ? ' active' : ''}`;
        el.dataset.id = conv.id;
        el.onclick = () => openConv(conv);
        el.innerHTML = `
          <div class="conv-avatar-wrap">
            <img class="conv-avatar" src="${esc(conv.otherAvatar)}" alt="" onerror="this.src='${fb(conv.otherName)}'">
            <div class="online-dot offline-dot"></div>
          </div>
          <div class="conv-info">
            <div class="conv-name-row">
              <span class="conv-name">${esc(conv.otherName)}</span>
              <span class="conv-time">${fmtTime(conv.lastMessageAt)}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span class="conv-preview" style="${conv.unread>0?'font-weight:600;color:var(--text-main);':''}">${esc(preview)}</span>
              ${conv.unread > 0 ? `<span class="conv-badge">${conv.unread}</span>` : ''}
            </div>
          </div>`;
        c.appendChild(el);
      });
    }

    function updateUnreadBadge() {
      const total = allConvs.reduce((s,x) => s + (x.unread||0), 0);
      const b = document.getElementById('unreadCountBadge');
      if (b) { b.textContent = total; b.style.display = total > 0 ? 'inline' : 'none'; }
    }

    // ‚îÄ‚îÄ‚îÄ KONU≈ûMA A√á ‚îÄ‚îÄ‚îÄ
    async function openConv(conv) {
      currentConvId = conv.id;
      currentOther  = conv;

      document.getElementById('chatAvatar').src = conv.otherAvatar;
      document.getElementById('chatAvatar').onerror = function(){ this.src = fb(conv.otherName); };
      document.getElementById('chatName').textContent = conv.otherName;
      document.getElementById('viewProfileBtn').onclick = () => window.open(`profil.html?uid=${conv.otherId}`,'_self');

      // Presence kontrol√º
      const ps = await getDoc(doc(db,'presence',conv.otherId)).catch(() => null);
      const pd = ps?.data() || {};
      const online = pd.state === 'online';
      const statusEl = document.getElementById('chatStatus');
      const dotEl    = document.getElementById('chatOnlineDot');
      if (online) {
        statusEl.textContent = '√áevrimi√ßi';
        statusEl.className   = 'chat-header-status';
        dotEl.className      = 'online-dot';
      } else {
        statusEl.textContent = `Son g√∂r√ºlme: ${pd.lastChanged ? fmtTime(pd.lastChanged) : 'bilinmiyor'}`;
        statusEl.className   = 'chat-header-status offline';
        dotEl.className      = 'online-dot offline-dot';
      }

      document.getElementById('chatEmpty').style.display = 'none';
      document.getElementById('activeChatArea').style.display = 'flex';
      document.getElementById('chatMessages').innerHTML = '<div class="msgs-loading"><div class="loading-spin"></div><span>Y√ºkleniyor...</span></div>';

      document.getElementById('convPanel').classList.add('hidden-mobile');
      document.getElementById('chatPanel').classList.add('show-mobile');

      // Okunmamƒ±≈ülarƒ± sƒ±fƒ±rla
      updateDoc(doc(db,'conversations',conv.id), { [`unreadCount.${currentUser.uid}`]: 0 }).catch(()=>{});

      // Eski dinleyicileri kapat
      if (msgsUnsub) msgsUnsub();
      if (typingUnsub) typingUnsub();

      listenMessages(conv.id);
      listenTyping(conv.id, conv.otherId);
      renderConvList();
    }

    // ‚îÄ‚îÄ‚îÄ MESAJLARI Dƒ∞NLE ‚îÄ‚îÄ‚îÄ
    function listenMessages(cid) {
      const q = query(collection(db,'conversations',cid,'messages'), orderBy('createdAt','asc'), limit(150));
      msgsUnsub = onSnapshot(q, snap => {
        renderMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      });
    }

    function renderMessages(msgs) {
      const c = document.getElementById('chatMessages');
      const atBottom = c.scrollHeight - c.scrollTop - c.clientHeight < 80;
      c.innerHTML = '';

      if (msgs.length === 0) {
        c.innerHTML = `<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--text-muted);font-size:0.83rem;padding:30px;">
          <i class="fa-regular fa-comments" style="font-size:2.2rem;opacity:0.4;"></i>
          <span>ƒ∞lk mesajƒ± sen g√∂nder!</span></div>`;
        return;
      }

      let lastDate = '';
      msgs.forEach(msg => {
        const mine = msg.senderId === currentUser.uid;
        const d    = msg.createdAt?.toDate?.() || new Date();
        const ds   = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
        const now  = new Date();
        const ns   = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;

        if (ds !== lastDate) {
          lastDate = ds;
          const lbl = ds === ns ? 'Bug√ºn' : `${d.getDate()} ${['Oca','≈ûub','Mar','Nis','May','Haz','Tem','Aƒüu','Eyl','Eki','Kas','Ara'][d.getMonth()]}`;
          const div = document.createElement('div');
          div.className = 'date-divider';
          div.innerHTML = `<span>${lbl}</span>`;
          c.appendChild(div);
        }

        const row = document.createElement('div');
        row.className = `msg-row ${mine ? 'mine' : 'theirs'}`;

        const avatar = !mine
          ? `<img class="msg-avatar" src="${esc(currentOther.otherAvatar)}" alt="" onerror="this.src='${fb(currentOther.otherName)}'">` : '';

        let content = '';
        if (msg.imageUrl) {
          content = `<img class="msg-img" src="${esc(msg.imageUrl)}" alt="Resim" onclick="window.open('${esc(msg.imageUrl)}','_blank')">`;
          if (msg.text) content += `<div style="margin-top:5px;">${esc(msg.text)}</div>`;
        } else {
          content = esc(msg.text || '');
        }

        const check = mine
          ? `<i class="fa-solid fa-check-double msg-check ${msg.read?'read':''}" style="font-size:0.65rem;"></i>` : '';

        row.innerHTML = `${avatar}<div><div class="msg-bubble">${content}</div><div class="msg-meta">${check}<span>${fullTime(msg.createdAt)}</span></div></div>`;
        c.appendChild(row);
      });

      if (atBottom) setTimeout(() => { c.scrollTop = c.scrollHeight; }, 30);
    }

    // ‚îÄ‚îÄ‚îÄ YAZILIYOR Dƒ∞NLE ‚îÄ‚îÄ‚îÄ
    function listenTyping(cid, otherId) {
      typingUnsub = onSnapshot(doc(db,'conversations',cid,'typing',otherId), snap => {
        const isTyping = snap.exists() && snap.data()?.typing === true;
        const c = document.getElementById('chatMessages');
        document.getElementById('typingRow')?.remove();
        if (isTyping) {
          const row = document.createElement('div');
          row.className = 'typing-indicator';
          row.id = 'typingRow';
          row.innerHTML = `<img src="${esc(currentOther.otherAvatar)}" alt="" onerror="this.src='${fb(currentOther.otherName)}'">
            <div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
          c.appendChild(row);
          c.scrollTop = c.scrollHeight;
        }
      });
    }

    // ‚îÄ‚îÄ‚îÄ YAZMA DURUMU G√ñNDER ‚îÄ‚îÄ‚îÄ
    window.handleTyping = async () => {
      if (!currentConvId || !currentUser) return;
      const r = doc(db,'conversations',currentConvId,'typing',currentUser.uid);
      await setDoc(r, { typing: true }).catch(()=>{});
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => deleteDoc(r).catch(()=>{}), 2500);
    };

    // ‚îÄ‚îÄ‚îÄ MESAJ G√ñNDER ‚îÄ‚îÄ‚îÄ
    window.sendMessage = async () => {
      const inp  = document.getElementById('msgInput');
      const text = inp.value.trim();
      if (!text && !pendingFile) return;
      if (!currentConvId || !currentUser) return;

      const btn = document.getElementById('sendBtn');
      btn.disabled = true;

      try {
        let imageUrl = null;
        if (pendingFile) {
          const r    = ref(storage, `messages/${currentConvId}/${Date.now()}_${pendingFile.name}`);
          const snap = await uploadBytes(r, pendingFile);
          imageUrl   = await getDownloadURL(snap.ref);
        }

        const msgData = {
          senderId:    currentUser.uid,
          senderName:  currentUser.displayName,
          senderAvatar: currentUser.avatar,
          text:        text || '',
          imageUrl:    imageUrl || null,
          createdAt:   serverTimestamp(),
          read:        false
        };

        await addDoc(collection(db,'conversations',currentConvId,'messages'), msgData);

        const preview = imageUrl ? (text || 'üì∑ Fotoƒüraf') : text;
        const convRef = doc(db,'conversations',currentConvId);
        try {
          await updateDoc(convRef, {
            lastMessage:   preview,
            lastMessageAt: serverTimestamp(),
            lastSenderId:  currentUser.uid,
            [`unreadCount.${currentOther.otherId}`]: (allConvs.find(x=>x.id===currentConvId)?.unread||0) + 1
          });
        } catch {
          await setDoc(convRef, {
            participants:   [currentUser.uid, currentOther.otherId],
            lastMessage:    preview,
            lastMessageAt:  serverTimestamp(),
            lastSenderId:   currentUser.uid,
            unreadCount:    { [currentOther.otherId]: 1, [currentUser.uid]: 0 },
            createdAt:      serverTimestamp()
          });
        }

        clearTimeout(typingTimer);
        deleteDoc(doc(db,'conversations',currentConvId,'typing',currentUser.uid)).catch(()=>{});
        inp.value = '';
        inp.style.height = 'auto';
        removeSendImg();
        closeEmojiPicker();
        const c = document.getElementById('chatMessages');
        c.scrollTop = c.scrollHeight;
      } catch(e) {
        console.error('Mesaj hatasƒ±:', e);
        alert('Mesaj g√∂nderilemedi. L√ºtfen tekrar dene.');
      }
      btn.disabled = false;
    };

    // ‚îÄ‚îÄ‚îÄ YENƒ∞ KONU≈ûMA BA≈ûLAT ‚îÄ‚îÄ‚îÄ
    window.startConvWith = async (otherUid) => {
      closeNewChatModal();
      const cid = convId(currentUser.uid, otherUid);
      const ref_ = doc(db,'conversations',cid);
      const s    = await getDoc(ref_);
      if (!s.exists()) {
        await setDoc(ref_, {
          participants:  [currentUser.uid, otherUid],
          lastMessage:   '',
          lastMessageAt: serverTimestamp(),
          lastSenderId:  '',
          unreadCount:   { [currentUser.uid]:0, [otherUid]:0 },
          createdAt:     serverTimestamp()
        });
      }
      const os = await getDoc(doc(db,'users',otherUid));
      const o  = os.data() || {};
      openConv({
        id: cid, otherId: otherUid,
        otherName:     o.displayName || 'Kullanƒ±cƒ±',
        otherUsername: o.username || '',
        otherAvatar:   o.avatar || fb(o.displayName),
        lastMessage:   s.exists() ? (s.data().lastMessage||'') : '',
        lastMessageAt: s.exists() ? s.data().lastMessageAt : null,
        lastSenderId:  s.exists() ? (s.data().lastSenderId||'') : '',
        unread: 0
      });
    };

    // ‚îÄ‚îÄ‚îÄ KONU≈ûMAYI Sƒ∞L ‚îÄ‚îÄ‚îÄ
    window.clearChat = async () => {
      if (!currentConvId || !confirm('Bu konu≈ümayƒ± silmek istediƒüine emin misin?')) return;
      const snap = await getDocs(collection(db,'conversations',currentConvId,'messages'));
      const batch_ = writeBatch(db);
      snap.docs.forEach(d => batch_.delete(d.ref));
      batch_.update(doc(db,'conversations',currentConvId), { lastMessage:'', lastMessageAt: serverTimestamp(), lastSenderId:'' });
      await batch_.commit();
    };

    // ‚îÄ‚îÄ‚îÄ KULLANICI ARA ‚îÄ‚îÄ‚îÄ
    window.searchUsers = async (val) => {
      const c = document.getElementById('userSearchResults');
      if (!val.trim()) {
        c.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.82rem;padding:10px;">Arama yapmak i√ßin yazmaya ba≈üla</div>';
        return;
      }
      c.innerHTML = '<div style="text-align:center;padding:10px;"><div class="loading-spin" style="margin:0 auto;"></div></div>';
      try {
        const snap = await getDocs(query(collection(db,'users'), limit(25)));
        const lower = val.toLowerCase();
        const results = [];
        snap.forEach(d => {
          if (d.id === currentUser.uid) return;
          const x = d.data();
          if ((x.displayName||'').toLowerCase().includes(lower) || (x.username||'').toLowerCase().includes(lower))
            results.push({ uid: d.id, ...x });
        });

        if (!results.length) {
          c.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.82rem;padding:10px;">Kullanƒ±cƒ± bulunamadƒ±</div>';
          return;
        }

        c.innerHTML = '';
        results.slice(0,8).forEach(u => {
          const el = document.createElement('div');
          el.className = 'user-search-item';
          el.innerHTML = `
            <img src="${esc(u.avatar||fb(u.displayName))}" alt="" onerror="this.src='${fb(u.displayName)}'">
            <div class="info">
              <div class="name">${esc(u.displayName||'Kullanƒ±cƒ±')}</div>
              <div class="handle">@${esc(u.username||'')}</div>
            </div>`;
          el.onclick = () => startConvWith(u.uid);
          c.appendChild(el);
        });
      } catch(e) {
        c.innerHTML = '<div style="text-align:center;color:red;font-size:0.82rem;padding:10px;">Hata olu≈ütu</div>';
      }
    };

    // ‚îÄ‚îÄ‚îÄ RESƒ∞M ‚îÄ‚îÄ‚îÄ
    window.handleImgSelect = (input) => {
      if (!input.files?.[0]) return;
      const file = input.files[0];
      pendingFile = file;
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById('sendImgThumb').src = e.target.result;
        document.getElementById('sendImgName').textContent = file.name;
        document.getElementById('sendImgPreview').classList.add('show');
      };
      reader.readAsDataURL(file);
    };

    window.removeSendImg = () => {
      pendingFile = null;
      document.getElementById('sendImgPreview').classList.remove('show');
      document.getElementById('sendImgThumb').src = '';
      document.getElementById('chatImgInput').value = '';
    };

    // ‚îÄ‚îÄ‚îÄ EMOJƒ∞ ‚îÄ‚îÄ‚îÄ
    window.toggleEmojiPicker = () => document.getElementById('msgEmojiPicker').classList.toggle('open');
    function closeEmojiPicker() { document.getElementById('msgEmojiPicker').classList.remove('open'); }

    document.addEventListener('click', e => {
      const picker = document.getElementById('msgEmojiPicker');
      const btn    = document.getElementById('emojiToggleBtn');
      if (picker && btn && !picker.contains(e.target) && !btn.contains(e.target)) closeEmojiPicker();
    });

    document.getElementById('msgEmojiPicker').addEventListener('click', e => {
      if (e.target.tagName === 'SPAN') {
        const inp = document.getElementById('msgInput');
        const pos = inp.selectionStart;
        inp.value = inp.value.slice(0,pos) + e.target.textContent + inp.value.slice(pos);
        inp.focus();
        inp.selectionStart = inp.selectionEnd = pos + e.target.textContent.length;
      }
    });

    // ‚îÄ‚îÄ‚îÄ ENTER ‚îÄ‚îÄ‚îÄ
    window.handleMsgKeydown = e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    };

    window.autoResize = el => {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 90) + 'px';
    };

    // ‚îÄ‚îÄ‚îÄ TAB & Fƒ∞LTRE ‚îÄ‚îÄ‚îÄ
    window.switchTab = (btn, tab) => {
      document.querySelectorAll('.conv-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      currentTab = tab;
      renderConvList();
    };

    window.filterConversations = val => { searchFilter = val; renderConvList(); };

    // ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ
    window.openNewChatModal = () => {
      document.getElementById('newChatModal').classList.add('open');
      document.getElementById('userSearchInput').value = '';
      document.getElementById('userSearchResults').innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.82rem;padding:10px;">Arama yapmak i√ßin yazmaya ba≈üla</div>';
      setTimeout(() => document.getElementById('userSearchInput').focus(), 100);
    };

    window.closeNewChatModal = () => document.getElementById('newChatModal').classList.remove('open');

    document.getElementById('newChatModal').addEventListener('click', e => {
      if (e.target === document.getElementById('newChatModal')) closeNewChatModal();
    });

    // ‚îÄ‚îÄ‚îÄ MOBƒ∞L ‚îÄ‚îÄ‚îÄ
    window.showConvPanel = () => {
      document.getElementById('convPanel').classList.remove('hidden-mobile');
      document.getElementById('chatPanel').classList.remove('show-mobile');
    };
  </script>

<script src="assets/js/include.js"></script>
<script type="module" src="assets/js/app.js"></script>
<script>
    const cities = ["Adana","Adƒ±yaman","Afyonkarahisar","Aƒürƒ±","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin","Aydƒ±n","Balƒ±kesir","Bartƒ±n","Batman","Bayburt","Bilecik","Bing√∂l","Bitlis","Bolu","Burdur","Bursa","√áanakkale","√áankƒ±rƒ±","√áorum","Denizli","Diyarbakƒ±r","D√ºzce","Edirne","Elazƒ±ƒü","Erzincan","Erzurum","Eski≈üehir","Gaziantep","Giresun","G√ºm√º≈ühane","Hakkari","Hatay","Iƒüdƒ±r","Isparta","ƒ∞stanbul","ƒ∞zmir","Kahramanmara≈ü","Karab√ºk","Karaman","Kars","Kastamonu","Kayseri","Kilis","Kƒ±rƒ±kkale","Kƒ±rklareli","Kƒ±r≈üehir","Kocaeli","Konya","K√ºtahya","Malatya","Manisa","Mardin","Mersin","Muƒüla","Mu≈ü","Nev≈üehir","Niƒüde","Ordu","Osmaniye","Rize","Sakarya","Samsun","≈ûanlƒ±urfa","Siirt","Sinop","≈ûƒ±rnak","Sivas","Tekirdaƒü","Tokat","Trabzon","Tunceli","U≈üak","Van","Yalova","Yozgat","Zonguldak"];
    
    let selectedCity = "Istanbul";
    let timerInterval;

    // ≈ûehir listesini doldur
    const select = document.getElementById('city-select');
    cities.forEach(city => {
        let opt = document.createElement('option');
        // API i√ßin T√ºrk√ße karakterleri temizle
        let val = city.replace(/ƒ∞/g, 'I').replace(/ƒ±/g, 'i').replace(/ƒû/g, 'G').replace(/ƒü/g, 'g').replace(/√ú/g, 'U').replace(/√º/g, 'u').replace(/≈û/g, 'S').replace(/≈ü/g, 's').replace(/√ñ/g, 'O').replace(/√∂/g, 'o').replace(/√á/g, 'C').replace(/√ß/g, 'c');
        opt.value = val;
        opt.innerHTML = city;
        if(city === "ƒ∞stanbul") opt.selected = true;
        select.appendChild(opt);
    });

    async function changeCity(cityVal) {
        selectedCity = cityVal;
        document.getElementById("active-city-name").innerText = select.options[select.selectedIndex].text;
        updateVakitler();
    }

    async function updateVakitler() {
        try {
            const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${selectedCity}&country=Turkey&method=13`);
            const data = await res.json();
            const timings = data.data.timings;
            
            if(timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = new Date();
                const ramadanStart = new Date("2026-02-19T00:00:00");
                
                let target;
                let title;

                if (now < ramadanStart) {
                    target = ramadanStart;
                    title = "üåô Ramazan'a Kalan";
                } else {
                    const [iH, iM] = timings.Imsak.split(':');
                    const [fH, fM] = timings.Maghrib.split(':');
                    const imsakToday = new Date(); imsakToday.setHours(iH, iM, 0);
                    const iftarToday = new Date(); iftarToday.setHours(fH, fM, 0);

                    if (now < imsakToday) { target = imsakToday; title = "‚è≥ Sahura Kalan"; }
                    else if (now < iftarToday) { target = iftarToday; title = "üç≤ ƒ∞ftara Kalan"; }
                    else { target = new Date(imsakToday.getTime() + 86400000); title = "‚ú® Sahura Kalan (Yarƒ±n)"; }
                }

                const diff = target - now;
                document.getElementById("status-title").innerText = title;
                document.getElementById("r-day").innerText = Math.floor(diff / 86400000).toString().padStart(2, '0');
                document.getElementById("r-hour").innerText = Math.floor((diff / 3600000) % 24).toString().padStart(2, '0');
                document.getElementById("r-min").innerText = Math.floor((diff / 60000) % 60).toString().padStart(2, '0');
                document.getElementById("r-sec").innerText = Math.floor((diff / 1000) % 60).toString().padStart(2, '0');
            }, 1000);
        } catch(e) { console.error("Hata:", e); }
    }

    async function openImsakiye() {
        const modal = document.getElementById("imsakiye-modal");
        const tbody = document.getElementById("imsakiye-body");
        document.getElementById("modal-city-title").innerText = select.options[select.selectedIndex].text + " ƒ∞msakiyesi";
        tbody.innerHTML = "<tr><td colspan='4'>Y√ºkleniyor...</td></tr>";
        modal.style.display = "flex";

        try {
            // ≈ûubat ve Mart 2026 verilerini √ßek (Ramazan her iki aya yayƒ±lƒ±yor)
            const res = await fetch(`https://api.aladhan.com/v1/calendarByCity/2026?city=${selectedCity}&country=Turkey&method=13`);
            const data = await res.json();
            
            let html = "";
            let ramadanDay = 1;
            
            // 19 ≈ûubat'tan itibaren 30 g√ºn d√∂n
            Object.keys(data.data).forEach(month => {
                data.data[month].forEach(day => {
                    const dateParts = day.date.gregorian.date.split('-'); // DD-MM-YYYY
                    const dateObj = new Date(dateParts[2], dateParts[1]-1, dateParts[0]);
                    const ramadanStart = new Date(2026, 1, 19); // 19 ≈ûubat
                    const ramadanEnd = new Date(2026, 2, 20); // 20 Mart (yakla≈üƒ±k)

                    if(dateObj >= ramadanStart && ramadanDay <= 30) {
                        html += `<tr>
                            <td>${ramadanDay}. G√ºn</td>
                            <td>${day.date.gregorian.day} ${day.date.gregorian.month.en.substring(0,3)}</td>
                            <td><b>${day.timings.Imsak.split(' ')[0]}</b></td>
                            <td class="accent-red"><b>${day.timings.Maghrib.split(' ')[0]}</b></td>
                        </tr>`;
                        ramadanDay++;
                    }
                });
            });
            tbody.innerHTML = html;
        } catch(e) { tbody.innerHTML = "<tr><td colspan='4'>Vakitler alƒ±namadƒ±.</td></tr>"; }
    }

    function closeImsakiye() { document.getElementById("imsakiye-modal").style.display = "none"; }

    updateVakitler();
</script>
</body>
</html>